@{
    ViewBag.Title = "HealthTarget";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@section scripts {
    <script type="text/javascript">
        $(function () {
            $.ajaxPost("@Url.Content("~/SystemInfo/Search")", {}, function (data) {
                if (data != null) {
                    $.each(data, function (index, item) {
                        $("#qSYSTEM_ID, #fSYSTEM_ID").append($("<option>", { text: item.NAME, value: item.ID }));
                    });
                }
            });

            $.ajaxPost("@Url.Content("~/VMInfo/Search")", {}, function (data) {
                if (data != null) {
                    $.each(data, function (index, item) {
                        $("#fVM_ID").append($("<option>", { text: item.ID, value: item.ID }));
                    });
                }
            });

            queryOnClick();
        });

        function queryOnClick() {
            $("#resultTable tbody tr").remove();

            var filter = {
                SYSTEM_ID: $("#qSYSTEM_ID").val(),
                VM_IPv4: $("#qVM_IPv4").val()
            }

            $("#infos .modal-body").html("<span style='font-size:24px'><i class='fa fa-spinner fa-spin'></i>查詢中…</span>");
            $("#infos").modal("show");

            $.ajaxPost("@Url.Content("~/HealthTarget/Search")", filter, function (data) {
                $("#infos").modal("hide");
                if ((data != null) && (data.length > 0)) {
                    $.each(data, function (index, item) {
                        var html = "";

                        html += "<tr>";
                        html += "  <td>";
                        html += "    <input type='hidden' id='" + item.OID + "' value='" + JSON.stringify(item) + "' />";
                        html += "    <button type='button' onclick='editOnClick(\"" + item.OID + "\");'>編輯</button>&nbsp;&nbsp;";
                        html += "    <button type='button' onclick='delOnClick(\"" + item.OID + "\");'>刪除</button>";
                        html += "  </td>";
                        html += "  <td class='text-center'>" + item.SYSTEM_ID + "</td>";
                        html += "  <td class='text-center'>" + item.VM_ID + "</td>";
                        html += "  <td class='text-center'>" + (item.VM_IPv4 != null ? item.VM_IPv4 : "") + "</td>";
                        html += "  <td class='text-left'>" + (item.VM_IPv6 != null ? item.VM_IPv6 : "") + "</td>";
                        html += "  <td class='text-left'>" + (item.URL != null ? item.URL : "") + "</td>";
                        html += "  <td class='text-center'>" + (item.ISVIP != null && item.ISVIP ? "是" : "否") + "</td>";
                        html += "  <td class='text-center'>" + (item.ACTIVE != null && item.ACTIVE ? "是" : "否") + "</td>";
                        html += "  <td class='text-center'>" + moment(item.CREATE_TIME).format("YYYY-MM-DD HH:mm:ss") + "</td>";
                        html += "  <td class='text-center'>" + (item.UPDATE_TIME != null ? moment(item.UPDATE_TIME).format("YYYY-MM-DD HH:mm:ss") : "") + "</td>";
                        html += "</tr>";

                        $("#resultTable tbody").append(html);
                    });
                }
            });
        }

        function newOnClick() {
            var obj = {
                OID: "",
                SYSTEM_ID: "",
                VM_ID: "",
                VM_IPv4: "",
                VM_IPv6: "",
                URL: "",
                ISVIP: false,
                ACTIVE: true
            };
            setFormFields(obj);

            $("#actionType").text("新增");
            $("#healthTarget").modal("show");
        }

        function editOnClick(oid) {
            var obj = JSON.parse($("#" + oid).val());
            setFormFields(obj);

            $("#actionType").text("編輯");
            $("#healthTarget").modal("show");
        }

        function confirmOnClick() {
            var actionType = $("#actionType").text();
            var obj = {
                OID: $("#fOID").val(),
                SYSTEM_ID: $("#fSYSTEM_ID").val(),
                VM_ID: $("#fVM_ID").val(),
                VM_IPv4: $("#fVM_IPv4").val(),
                VM_IPv6: $("#fVM_IPv6").val(),
                URL: $("#fURL").val(),
                ISVIP: $("#fISVIP").prop("checked"),
                ACTIVE: $("#fACTIVE").prop("checked")
            };

            if ((obj.VM_IPv4 === "") || (obj.URL === "")) {
                alert("IPv4及URL不能為空值！");
            }
            else {
                var url = (actionType == "新增") ? "@Url.Content("~/HealthTarget/Create")" : "@Url.Content("~/HealthTarget/Update")";
                $.ajaxPost(url, obj, function (data) {
                    $("#healthTarget").modal("hide");
                    queryOnClick();
                });
            }
        }

        function delOnClick(oid) {
            var obj = JSON.parse($("#" + oid).val());

            if (confirm("確認刪除" + obj.SYSTEM_ID + "：" + obj.VM_ID + "？")) {
                $.ajaxPost("@Url.Content("~/HealthTarget/Delete")", obj, function (data) {
                    queryOnClick();
                });
            }
        }

        function setFormFields(obj) {
            $("#fOID").val(obj.OID);
            $("#fSYSTEM_ID").val(obj.SYSTEM_ID);
            $("#fVM_ID").val(obj.VM_ID);
            $("#fVM_IPv4").val(obj.VM_IPv4);
            $("#fVM_IPv6").val(obj.VM_IPv6);
            $("#fURL").val(obj.URL);
            $("#fISVIP").prop("checked", obj.ISVIP);
            $("#fACTIVE").prop("checked", obj.ACTIVE);
        }
    </script>
}
<br />
<div class="row">
    <div class="col-lg-1 col-md-1 col-sm-6 col-xs-12">
        <label>SYSTEM：</label>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <select id="qSYSTEM_ID" class="form-control">
            <option value="">全部</option>
        </select>
    </div>
    <div class="col-lg-1 col-md-1 col-sm-6 col-xs-12">
        <label>IPv4：</label>
    </div>
    <div class="col-lg-2 col-md-2 col-sm-6 col-xs-12">
        <input type="text" id="qVM_IPv4" class="form-control" />
    </div>
    <div class="col-lg-offset-3 col-md-offset-3 col-lg-2 col-md-2 col-sm-12 col-xs-12">
        <button type="button" class="btn btn-primary" onclick="queryOnClick();">查詢</button>
        <button type="button" class="btn btn-default" onclick="newOnClick();">新增</button>
    </div>
</div>
<br />
<div class="table-responsive">
    <table id="resultTable" class="table table-bordered table-striped table-hover">
        <thead>
            <tr>
                <th></th>
                <th class="text-center">SYSTEM ID</th>
                <th class="text-center">VM ID</th>
                <th class="text-center">VM IPv4</th>
                <th class="text-center">VM IPv6</th>
                <th class="text-center">URL</th>
                <th class="text-center">IS VIP</th>
                <th class="text-center">ACTIVE</th>
                <th class="text-center">建立時間</th>
                <th class="text-center">異動時間</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<div class="modal fade" id="healthTarget" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><span class="glyphicon glyphicon-lock"></span><span id="actionType"></span></h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fOID" />
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">SYSTEM ID：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <select id="fSYSTEM_ID"></select>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">VM ID：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <select id="fVM_ID"></select>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">VM IPv4：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <input type="text" id="fVM_IPv4" />
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">VM IPv6：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <input type="text" id="fVM_IPv6" />
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">URL：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <input type="text" id="fURL" />
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">IS VIP：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <input type="checkbox" id="fISVIP" />
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">ACTIVE：</div>
                    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                        <input type="checkbox" id="fACTIVE" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary pull-left" onclick="confirmOnClick();"><span class="glyphicon glyphicon-remove"></span> 確認</button>
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> 取消</button>
            </div>
        </div>
    </div>
</div>
