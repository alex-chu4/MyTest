@using Health.Web.Controllers
@using Health.Web.Models
@{
    ViewBag.Title = "APM監控儀表板-主機狀態";
}
@section styles {
    <style type="text/css">
        #healthCurrent.row {
            display: flex;
            flex-wrap: wrap;
        }

        #healthCurrent.row > [class*='col-'] {
            display: flex;
            flex-direction: column;
        }
    </style>
}
@section scripts {
    <script type="text/javascript">
        $(function () {
            $("#alerts")
                .on("hide.bs.modal", function () {
                    var sound = document.getElementById("sound");
                    sound.pause();
                });

            refreshHealthCurrentView();
            refreshCurrentUser();

            setInterval(function () {
                refreshHealthCurrentView();
                refreshCurrentUser();
            }, @RptController.RefreshInterval);
        });

        function rowOnClick(systemID, systemName, vmID) {
            $("input[name='SYSTEM_ID']").val(systemID);
            $("input[name='SYSTEM_NAME']").val(systemName);
            $("input[name='VM_ID']").val(vmID);
            $("#formHis").submit();
        }

        function funcOnClick(systemID, systemName, threshold) {
            $("input[name='SYSTEM_ID']").val(systemID);
            $("input[name='SYSTEM_NAME']").val(systemName);
            $("input[name='THRESHOLD']").val(threshold);
            $("#formHis2").submit();
        }

        function refreshCurrentUser() {
            $("#usersNumber").text("");
            $.ajaxGet("@Url.Content("~/UserToken/GetCurrentUsers")", null, function (data) {
                if (data != null) {
                    $("#usersNumber").text(data);
                }
            });
        }

        function refreshHealthCurrentView() {
            $("#healthCurrent").html("");
            $("#alertsNumber").text("");

            $.ajaxGet("@Url.Content("~/HealthCurrent/GetCurrentView")", null, function (data) {
                var alertsName = [];

                if ((data != null) && (data.m_Item1 != null) && (data.m_Item1.length > 0)) {
                    var alertsNumber = 0;

                    for (var item1Index = 0; item1Index < data.m_Item1.length; item1Index++) {
                        var html = '<div class="col-md-3">' +
                            '<div class="widget">' +
                            '<div class="widget-head">' +
                            '<div class="pull-left">' + data.m_Item1[item1Index].NAME + '</div>' +
                            '<div class="clearfix"></div>' +
                            '</div><!-- widget-head -->' +
                            '<div class="widget-content">' +
                            '<div class="table-responsive">' +
                            '<table class="table table-striped table-bordered table-hover">' +
                            '<thead>' +
                            '<tr>' +
                            '<th>狀態</th>' +
                            '<th>主機/事件</th>' +
                            '<th>AP Server IP</th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody>';

                        for (var item2Index = 0; item2Index < data.m_Item2.length; item2Index++) {
                            if (data.m_Item1[item1Index].ID == data.m_Item2[item2Index].SYSTEM_ID) {
                                html += '<tr onclick="rowOnClick(\'' + data.m_Item2[item2Index].SYSTEM_ID +
                                    '\',\'' + data.m_Item2[item2Index].SYSTEM_NAME +
                                    '\',\'' + data.m_Item2[item2Index].VM_ID + '\');" style="cursor:pointer">' +
                                    '<td class="text-center">';
                                if (data.m_Item2[item2Index].STATUS) {
                                    html += '<span class="label label-success">上線</span>';
                                }
                                else {
                                    html += '<span class="label label-danger">離線</span>';
                                    alertsNumber += 1;
                                    alertsName.push(data.m_Item2[item2Index].VM_ID + '(' + data.m_Item2[item2Index].VM_IPv4 + ') 離線');
                                }

                                html += '</td>' +
                                    '<td>' + data.m_Item2[item2Index].VM_ID + '</td>' +
                                    '<td>' + data.m_Item2[item2Index].VM_IPv4 + '</td>' +
                                    '</tr>';
                            }
                        }

                        if (data.m_Item1[item1Index].KEY_FUNCTION) {
                            html += '<tr onclick="funcOnClick(\'' + data.m_Item1[item1Index].ID +
                                '\',\'' + data.m_Item1[item1Index].NAME + '\',' + data.m_Item1[item1Index].THRESHOLD + ');" style="cursor:pointer">' +
                                '<td></td><td><span name=\'' + data.m_Item1[item1Index].ID + '\'>重要事件</span></td><td></td>' +
                                '</tr>';
                        }

                        html += '</tbody>' +
                            '</table>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>';

                        $('#healthCurrent').append(html);
                    }
                    $('#alertsNumber').text(alertsNumber);
                }
                else {
                    $('#alertsNumber').text('0');
                }

                if ((data != null) && (data.m_Item3 != null) && (data.m_Item3.length > 0)) {
                    for (var item3Index = 0; item3Index < data.m_Item3.length; item3Index++) {
                        $('span[name="' + data.m_Item3[item3Index].SYSTEM_ID + '"]').addClass('label label-danger');
                        alertsName.push(data.m_Item3[item3Index].SYSTEM_NAME + '的' +
                            data.m_Item3[item3Index].FUNCTION_NAME + '(' +
                            (data.m_Item3[item3Index].IPv4 != null ? data.m_Item3[item3Index].IPv4 : '')  + ') 超過Threshold');
                    }
                    $('#eventsNumber').text(data.m_Item3.length);
                }
                else {
                    $('#eventsNumber').text('0');
                }

                if (alertsName.length > 0) {
                    $('#alerts .modal-body').html(alertsName.join('<br />'));
                    // https://developers.google.com/web/updates/2017/09/autoplay-policy-changes
                    document.getElementById('sound').play();
                    $('#alerts').modal('show');
                }
                else {
                    $('#alerts').modal('hide');
                }
            });
        }
    </script>
}
<audio id="sound" loop preload="auto">
    <source src="@Url.Content("~/Content/Responding5.wav")" type="audio/wav" />
</audio>
<form method="post" id="formHis" action="@Url.Action("EMIC2_His","Rpt")">
    <input type="hidden" name="SYSTEM_ID" />
    <input type="hidden" name="SYSTEM_NAME" />
    <input type="hidden" name="VM_ID" />
</form>
<form method="post" id="formHis2" action="@Url.Action("EMIC2_His2","Rpt")">
    <input type="hidden" name="SYSTEM_ID" />
    <input type="hidden" name="SYSTEM_NAME" />
    <input type="hidden" name="THRESHOLD" />
</form>
<!-- Table -->
<div class="row" id="healthCurrent">
</div>
