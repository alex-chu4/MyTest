@using Health.API.Models
@model HealthHisModel
@{
    ViewBag.Title = "APM監控儀表板-趨勢分析";
}
@section styles {
    <link href="~/Content/fullcalendar.min.css" rel="stylesheet" />
    <link href="~/Content/jquery.dataTables.min.css" rel="stylesheet" />
}
@section scripts {
    <script type="text/javascript">
        var lineChart;
        var hisTable;

        $(function () {
            var startTime = moment(moment().format("YYYY-MM-DD"));
            var endTime = moment(moment().format("YYYY-MM-DD 23:59:59"));

            $("#datetimepicker1, #datetimepicker3").datetimepicker({
                format: "YYYY-MM-DD"
            });

            $("#datetimepicker2, #datetimepicker4").datetimepicker({
                format: "HH:mm"
            });
            $("#datetimepicker1").data("DateTimePicker").date(startTime);
            $("#datetimepicker2").data("DateTimePicker").date(startTime);
            $("#datetimepicker3").data("DateTimePicker").date(endTime);
            $("#datetimepicker4").data("DateTimePicker").date(endTime);

            hisTable = $("#hisTable").DataTable({
                paging: true,
                pagingType: 'simple_numbers',
                pageLength: 5,
                lengthChange: false,
                searching: false,
                info: false,
                ordering: false,
                language: {
                    emptyTable: '無資料',
                    paginate: {
                        previous: '上頁',
                        next: '下頁'
                    }
                }
            });

            lineChart = Morris.Line({
                element: 'lineChart',
                xkey: 'CREATE_TIME',
                ykeys: ['SYSTEM_TIME', 'PROCESS_TIME', 'DB_TIME'],
                labels: ['Client至主機回應時間', '系統處理時間', '資料庫處理時間'],
                hideHover: 'auto',
                resize: true,
                lineColors: ['#e16500', '#1ab394', 'lightblue'],
            });

            $(":radio[name='optionsRadios']").change(optionsRadiosOnChange);
            $("#query").click(queryOnClick);
            queryOnClick();
        });

        function optionsRadiosOnChange() {
            var endTime = moment();
            var startTime = moment();

            switch ($(":radio[name='optionsRadios']:checked").val()) {
                case "option1": // 一年
                    startTime.subtract(1, "y");
                    break;
                case "option2": // 一個月
                    startTime.subtract(1, "M");
                    break;
                case "option3": // 一週
                    startTime.subtract(1, "w");
                    break;
                case "option4": // 一天
                    startTime.subtract(1, "d");
                    break;
                case "option5": // 一小時
                    startTime.subtract(1, "h");
                    break;
            }

            $("#datetimepicker1").data("DateTimePicker").date(startTime);
            $("#datetimepicker2").data("DateTimePicker").date(startTime);
            $("#datetimepicker3").data("DateTimePicker").date(endTime);
            $("#datetimepicker4").data("DateTimePicker").date(endTime);
        }

        function queryOnClick() {
            var datetimepicker1 = $("#datetimepicker1").data("DateTimePicker").date();
            var datetimepicker2 = $("#datetimepicker2").data("DateTimePicker").date();
            var datetimepicker3 = $("#datetimepicker3").data("DateTimePicker").date();
            var datetimepicker4 = $("#datetimepicker4").data("DateTimePicker").date();

            var startTime = getDateTime(datetimepicker1, datetimepicker2);
            var endTime = getDateTime(datetimepicker3, datetimepicker4);

            if (startTime == '') {
                startTime = moment().format("YYYY-MM-DD");
            }

            if (endTime == '') {
                endTime = moment().format("YYYY-MM-DD 23:59:59");
            }

            var filter = {
                SYSTEM_ID: $("#SYSTEM_ID").val(),
                VM_ID: $("#VM_ID").val(),
                START_TIME: startTime,
                END_TIME: endTime
            };

            refreshHealthCurrentView();
            refreshCurrentUser();
            $.ajaxPost("@Url.Content("~/HealthHis/Search")", filter, function (data) {
                refreshLineChart(data);
                refreshHisTable(data);
            });
        }

        function refreshLineChart(data) {
            lineChart.setData(data);
        }

        function refreshHisTable(data) {
            hisTable.clear();

            if ((data != null) && (data.length > 0)) {
                $.each(data, function (index, item) {
                    var html = '';
                    var createTime = moment(item.CREATE_TIME);

                    html += '<tr>' +
                        '<td class="text-center">';
                    if ((item.STATUS == null) || !item.STATUS) {
                        html += '<span class="label label-danger">離線</span>';
                    }
                    else {
                        html += '<span class="label label-success">上線</span>';
                    }
                    html += '</td>' +
                        '<td>' + item.VM_ID + '</td>' +
                        '<td class="text-center">' + item.VM_IPv4 + '</td>' +
                        '<td class="text-center">' + (item.CREATE_TIME != null ? createTime.format("YYYY-MM-DD") : '') + '</td>' +
                        '<td class="text-center">' + (item.CREATE_TIME != null ? createTime.format("HH:mm") : '') + '</td>' +
                        '<td class="text-right">' + (item.SYSTEM_TIME != null ? item.SYSTEM_TIME.toFixed(6) : '') + '</td>' +
                        '<td class="text-right">' + (item.PROCESS_TIME != null ? item.PROCESS_TIME.toFixed(6) : '') + '</td>' +
                        '<td class="text-right">' + (item.DB_TIME != null ? item.DB_TIME.toFixed(6) : '') + '</td>' +
                        '</tr>';

                    hisTable.row.add($(html));
                });
            }

            hisTable.draw();
        }

        function getDateTime(dtpicker1, dtpicker2) {
            var dateTime = '';

            if (dtpicker1 != null) {
                dateTime += dtpicker1.format("YYYY-MM-DD");
                if (dtpicker2 != null) {
                    dateTime += ' ' + dtpicker2.format("HH:mm");
                }
            }

            return dateTime;
        }

        function refreshCurrentUser() {
            $("#usersNumber").text("");
            $.ajaxGet("@Url.Content("~/UserToken/GetCurrentUsers")", null, function (data) {
                if (data != null) {
                    $("#usersNumber").text(data);
                }
            });
        }

        function refreshHealthCurrentView() {
            $("#alertsNumber").text("");
            $.ajaxGet("@Url.Content("~/HealthCurrent/GetCurrentView")", null, function (data) {
                if ((data != null) && (data.m_Item1.length > 0)) {
                    var item1Index = 0;
                    var item2Index = 0;
                    var alertsNumber = 0;

                    for (; item1Index < data.m_Item1.length; item1Index++) {
                        for (; item2Index < data.m_Item2.length; item2Index++) {
                            if (!data.m_Item2[item2Index].STATUS) {
                                alertsNumber += 1;
                            }
                        }
                        $("#alertsNumber").text(alertsNumber);
                    }
                }
                else {
                    $("#alertsNumber").text("0");
                }

                $('#eventsNumber').text(data.m_Item3.length);
            });
        }
    </script>
}
<div class="row">
    <div class="col-md-12">
        <!-- Curve chart starts -->
        <div class="widget">
            <div class="widget-head">
                <div class="pull-left">查詢選項</div>
                <div class="widget-icons pull-right">
                    <a href="#" class="wminimize">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="widget-content">
                <div class="padd">
                    <!-- Form starts.  -->
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label class="col-lg-2 control-label">系統別</label>
                            <div class="col-lg-2">
                                <input type="text" id="SYSTEM_NAME" class="form-control" value="@Model.SYSTEM_NAME" readonly />
                                <input type="hidden" id="SYSTEM_ID" value="@Model.SYSTEM_ID" />
                            </div>
                            <label class="col-lg-1 control-label">主機</label>
                            <div class="col-lg-1">
                                <input type="text" id="VM_ID" class="form-control" value="@Model.VM_ID" readonly />
                            </div>
                        </div>
                        <hr />
                        <div class="form-group">
                            <label class="col-lg-2 control-label">期間別</label>
                            <div class="col-lg-3">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="optionsRadios" value="option1">
                                        <span class="radios-select">一年</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="optionsRadios" value="option2">
                                        <span class="radios-select">一個月</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="optionsRadios" value="option3">
                                        <span class="radios-select">一週</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="optionsRadios" value="option4">
                                        <span class="radios-select">一天</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="optionsRadios" value="option5">
                                        <span class="radios-select">一小時</span>
                                    </label>
                                </div>
                            </div>
                            <label class="col-lg-1 control-label">開始時間</label>
                            <div class="col-lg-2">
                                <div id="datetimepicker1" class="input-append input-group dtpicker">
                                    <input type="text" class="form-control">
                                    <span class="input-group-addon add-on">
                                        @*<i data-time-icon="fa fa-times" data-date-icon="fa fa-calendar"></i>*@
                                        <i class="glyphicon glyphicon-calendar"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div id="datetimepicker2" class="input-append input-group dtpicker">
                                    <input class="form-control" type="text">
                                    <span class="input-group-addon add-on">
                                        @*<i data-time-icon="fa fa-clock-o" data-date-icon="fa fa-calendar"></i>*@
                                        <i class="glyphicon glyphicon-time"></i>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-offset-5 col-lg-1 control-label">結束時間</label>
                            <div class="col-lg-2">
                                <div id="datetimepicker3" class="input-append input-group dtpicker">
                                    <input type="text" class="form-control">
                                    <span class="input-group-addon add-on">
                                        @*<i data-time-icon="fa fa-times" data-date-icon="fa fa-calendar"></i>*@
                                        <i class="glyphicon glyphicon-calendar"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div id="datetimepicker4" class="input-append input-group dtpicker">
                                    <input class="form-control" type="text">
                                    <span class="input-group-addon add-on">
                                        @*<i data-time-icon="fa fa-clock-o" data-date-icon="fa fa-calendar"></i>*@
                                        <i class="glyphicon glyphicon-time"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <button id="query" type="button" class="btn btn-sm btn-primary">送出</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Curve chart ends -->
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <!-- Curve chart starts -->
        <div class="widget">
            <div class="widget-head">
                <div class="pull-left">趨勢分析圖</div>
                <div class="widget-icons pull-right">
                    <a href="#" class="wminimize">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
                <div class="clearfix"></div>
            </div>


            <div class="widget-content">
                <div id="lineChart"></div>
            </div>
        </div>
        <!-- Curve chart ends -->
    </div>

</div>

<div class="row">
    <div class="col-md-12">
        <!-- Curve chart starts -->
        <div class="widget">
            <div class="widget-head">
                <div class="pull-left">歷史資料</div>
                <div class="widget-icons pull-right">
                    <a href="#" class="wminimize">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                </div>
                <div class="clearfix"></div>
            </div>


            <div class="widget-content">
                <div class="table-responsive">
                    <table id="hisTable" class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th class="text-center">狀態</th>
                                <th class="text-center">主機</th>
                                <th class="text-center">AP Server IP</th>
                                <th class="text-center">日期</th>
                                <th class="text-center">時間</th>
                                <th class="text-center">主機回應時間(秒)</th>
                                <th class="text-center">系統處理時間(秒)</th>
                                <th class="text-center">資料庫處理時間(秒)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Curve chart ends -->
    </div>
</div>
